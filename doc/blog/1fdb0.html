<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">


<!-- Mirrored from updatecontrols.net/doc/blog/1?page=4 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:54:22 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>MichaelLPerry's blog | Update Controls .NET</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../blogapi/wlwmanifest.html" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../blogapi/rsd" />
<link rel="alternate" type="application/rss+xml" title="RSS - MichaelLPerry&#039;s blog" href="1/feed" />
<link rel="shortcut icon" href="../http_/updatecontrols.net/favicon.html" type="image/x-icon" />
  <link type="text/css" rel="stylesheet" media="all" href="../modules/book/book4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/node/node4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/defaults4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/system/system-menus4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../modules/user/user4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/modules/views/css/views4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/updatecontrols/html-elements4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/zen/zen/tabs4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/zen/zen/messages4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/zen/zen/block-editing4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/zen/zen/wireframes4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/updatecontrols/layout4b43.css?r" />
<link type="text/css" rel="stylesheet" media="all" href="../sites/all/themes/updatecontrols/updatecontrols4b43.css?r" />
<link type="text/css" rel="stylesheet" media="print" href="../sites/all/themes/updatecontrols/print4b43.css?r" />
<!--[if IE]>
<link type="text/css" rel="stylesheet" media="all" href="/doc/sites/all/themes/zen/zen/ie.css?r" />
<![endif]-->
  <script type="text/javascript" src="../misc/jquery4b43.js?r"></script>
<script type="text/javascript" src="../misc/drupal4b43.js?r"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, { "basePath": "/doc/", "googleanalytics": { "trackOutgoing": 1, "trackMailto": 1, "trackDownload": 1, "trackDownloadExtensions": "7z|aac|avi|csv|doc|exe|flv|gif|gz|jpe?g|js|mp(3|4|e?g)|mov|pdf|phps|png|ppt|rar|sit|tar|torrent|txt|wma|wmv|xls|xml|zip" } });
//--><!]]>
</script>
</head>
<body class="not-front not-logged-in one-sidebar sidebar-left page-blog-1 section-blog">

  <div id="page"><div id="page-inner">

    <a name="top" id="navigation-top"></a>
          <div id="skip-to-nav"><a href="#navigation">Skip to Navigation</a></div>
    
    <div id="header"><div id="header-inner" class="clear-block">

              <div id="logo-title">

                      <div id="logo"><a href="../index.html" title="Home" rel="home"><img src="../images/logosmall.jpg" alt="Home" id="logo-image" /></a></div>
          
                                    <div id="site-name"><strong>
                <a href="../index.html" title="Home" rel="home">
                Update Controls .NET                </a>
              </strong></div>
                      
          
        </div> <!-- /#logo-title -->
      
      
    </div></div> <!-- /#header-inner, /#header -->

    <div id="main"><div id="main-inner" class="clear-block with-navbar">

      <div id="content"><div id="content-inner">

        
        
                  <div id="content-header">
            <div class="breadcrumb"><a href="../index.html">Home</a> › <a href="../blog.html">Blogs</a> › </div>                          <h1 class="title">MichaelLPerry's blog</h1>
                                                          </div> <!-- /#content-header -->
        
        <div id="content-area">
          <div class="item-list"></div><div id="node-4" class="node node-teaser node-type-blog"><div class="node-inner">

  
      <h2 class="title">
      <a href="../examples/multi-threading.html" title="Multi-threading">Multi-threading</a>
    </h2>
  
  
      <div class="meta">
              <div class="submitted">
          Submitted by MichaelLPerry on Sat, 10/10/2009 - 12:27        </div>
      
          </div>
  
  <div class="content">
    <p>Multithreaded programming doesn't have to be hard. You just need to learn a few patterns.</p>
<p>Here's a common problem. How do you notify the UI thread that something has changed on a background thread? The INotifyPropertyChanged contract requires that the PropertyChanged event be fired on the UI thread. There are <a href="http://leecampbell.blogspot.com/2009/02/responsive-wpf-user-interfaces-part-3.html">ways</a> of marshalling that event from the background to the foreground, but wouldn't it be nice if you didn't have to?</p>
<p><a href="../../index.html">Update Controls</a> takes care of this problem for you. You make sure your code is thread-safe, and Update Controls will make sure that dependents are updated, no matter what thread they are on.</p>
<p><strong>A thread-safe model</strong><br />For Update Controls to work properly -- and indeed for your entire application to work properly -- you need your data model to be thread safe. That means that anything that can change is protected with a lock. If it can change (and you are using Update Controls), then it should have an <a href="../../documentation/classDocumentation/cs/UpdateControls.Independent.html">Independent</a> sentry. Just be sure to call OnGet and OnSet inside the lock.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Playlist
{
    <span style="color: blue">private</span> <span style="color: blue">int</span> _id;
    <span style="color: blue">private</span> <span style="color: blue">string</span> _name;

    <span style="color: blue">public</span> Playlist(<span style="color: blue">int</span> id)
    {
        _id = id;
    }

    <span style="color: blue">public</span> <span style="color: blue">int</span> ID
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _id; }
    }

    <span style="color: blue">#region</span> Independent properties
    <span style="color: green">// Generated by Update Controls --------------------------------</span>
    <span style="color: blue">private</span> Independent _indName = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> <span style="color: blue">string</span> Name
    {
        <span style="color: blue">get</span>
        {
            <span style="color: blue">lock</span> (<span style="color: blue">this</span>)
            {
                _indName.OnGet();
                <span style="color: blue">return</span> _name;
            }
        }
        <span style="color: blue">set</span>
        {
            <span style="color: blue">lock</span> (<span style="color: blue">this</span>)
            {
                _indName.OnSet();
                _name = value;
            }
        }
    }
    <span style="color: green">// End generated code --------------------------------</span>
    <span style="color: blue">#endregion</span>
}</pre><p><br />When dealing with collections, we need to be a little careful. If you return an IEnumerable that traverses a collection, that IEnumerable will leave the lock. This will cause problems, as another thread can come in and modify the collection while you are traversing it. To be safe, we need to create a copy of the collection within the lock.<br /></p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> MusicLibrary
{
    <span style="color: blue">private</span> List&lt;Playlist&gt; _playlists = <span style="color: blue">new</span> List&lt;Playlist&gt;();

    <span style="color: blue">#region</span> Independent properties
    <span style="color: green">// Generated by Update Controls --------------------------------</span>
    <span style="color: blue">private</span> Independent _indPlaylists = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> Playlist GetPlaylist(<span style="color: blue">int</span> playlistID)
    {
        <span style="color: blue">lock</span> (<span style="color: blue">this</span>)
        {
            <span style="color: green">// This method changes the list.</span>
            _indPlaylists.OnSet();

            <span style="color: green">// See if we already have this one.</span>
            Playlist playlist = _playlists.Where(p =&gt; p.ID == playlistID).FirstOrDefault();
            <span style="color: blue">if</span> (playlist != <span style="color: blue">null</span>)
                <span style="color: blue">return</span> playlist;

            <span style="color: green">// If not, create it.</span>
            playlist = <span style="color: blue">new</span> Playlist(playlistID);
            _playlists.Add(playlist);
            <span style="color: blue">return</span> playlist;
        }
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> DeletePlaylist(Playlist playlist)
    {
        <span style="color: blue">lock</span> (<span style="color: blue">this</span>)
        {
            _indPlaylists.OnSet();
            _playlists.Remove(playlist);
        }
    }

    <span style="color: blue">public</span> IEnumerable&lt;Playlist&gt; Playlists
    {
        <span style="color: blue">get</span>
        {
            <span style="color: blue">lock</span> (<span style="color: blue">this</span>)
            {
                _indPlaylists.OnGet();
                <span style="color: green">// Return a copy of the list so that it can be accessed in a</span>
                <span style="color: green">// thread-safe manner.</span>
                <span style="color: blue">return</span> <span style="color: blue">new</span> List&lt;Playlist&gt;(_playlists);
            }
        }
    }
    <span style="color: green">// End generated code --------------------------------</span>
    <span style="color: blue">#endregion</span>
}</pre><p>With this, your model is safe to access from multiple threads. So let's create one.</p>
<p><strong>Create a thread to communicate with external systems</strong><br />The UI thread is for the user. If you use it to communicate with external systems, it might hang. Then the user will have to decide whether to "Continue Waiting" or "Switch To...". Switch to what, a Mac? But seriously, it's better if you spawn a new thread to do all of your communication with external systems.</p>
<p>Commuter communicates with iTunes. So I created a separate thread to synchronize between iTunes and my data model. It wakes up every 10 seconds and refreshes the playlists.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> ITunesSynchronizationService
{
    <span style="color: blue">private</span> MusicLibrary _musicLibrary;
    <span style="color: blue">private</span> Thread _thread;
    <span style="color: blue">private</span> ManualResetEvent _stop;
    <span style="color: blue">private</span> <span style="color: blue">bool</span> _first = <span style="color: maroon">true</span>;

    <span style="color: blue">private</span> <span style="color: blue">string</span> _lastError = <span style="color: blue">string</span>.Empty;
    <span style="color: blue">private</span> Independent _indLastError = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> ITunesSynchronizationService(MusicLibrary musicLibrary)
    {
        _musicLibrary = musicLibrary;
        _thread = <span style="color: blue">new</span> Thread(ThreadProc);
        _thread.Name = <span style="color: maroon">"iTunes synchronization service"</span>;
        _stop = <span style="color: blue">new</span> ManualResetEvent(<span style="color: maroon">false</span>);
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> Start()
    {
        _thread.Start();
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> Stop()
    {
        _stop.Set();

        <span style="color: green">// Give it 30 seconds to shut down.</span>
        _thread.Join(<span style="color: maroon">30000</span>);
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> LastError
    {
        <span style="color: blue">get</span>
        {
            <span style="color: blue">lock</span> (<span style="color: blue">this</span>)
            {
                _indLastError.OnGet();
                <span style="color: blue">return</span> _lastError;
            }
        }

        <span style="color: blue">private</span> <span style="color: blue">set</span>
        {
            <span style="color: blue">lock</span> (<span style="color: blue">this</span>)
            {
                _indLastError.OnSet();
                _lastError = value;
            }
        }
    }

    <span style="color: blue">private</span> <span style="color: blue">void</span> ThreadProc()
    {
        <span style="color: blue">while</span> (ShouldContinue())
        {
            <span style="color: blue">try</span>
            {
                <span style="color: green">// Connect to iTunes.</span>
                iTunesApp itApp = <span style="color: blue">new</span> iTunesAppClass();

                <span style="color: green">// List all of the playlists.</span>
                List&lt;Playlist&gt; oldPlaylists = _musicLibrary.Playlists.ToList();
                <span style="color: blue">foreach</span> (IITUserPlaylist itPlaylist <span style="color: blue">in</span> itApp.LibrarySource.Playlists.OfType&lt;IITUserPlaylist&gt;())
                {
                    <span style="color: blue">string</span> name = itPlaylist.Name;
                    Playlist playlist = _musicLibrary.GetPlaylist(itPlaylist.playlistID);
                    <span style="color: blue">if</span> (name != <span style="color: blue">null</span> &amp;&amp; playlist.Name != name)
                        playlist.Name = name;
                    oldPlaylists.Remove(playlist);
                }

                <span style="color: green">// Delete all that are no longer in iTunes.</span>
                <span style="color: blue">foreach</span> (Playlist playlist <span style="color: blue">in</span> oldPlaylists)
                    _musicLibrary.DeletePlaylist(playlist);

                LastError = <span style="color: blue">string</span>.Empty;
            }
            <span style="color: blue">catch</span> (Exception ex)
            {
                LastError = ex.Message;
            }
        }
    }
    <span style="color: blue">private</span> <span style="color: blue">bool</span> ShouldContinue()
    {
        <span style="color: green">// Don't wait the first time.</span>
        <span style="color: blue">if</span> (_first)
        {
            _first = <span style="color: maroon">false</span>;
            <span style="color: blue">return</span> <span style="color: maroon">true</span>;
        }

        <span style="color: green">// Wake up every 10 seconds, or when the thread should stop.</span>
        <span style="color: blue">return</span> !_stop.WaitOne(<span style="color: maroon">10000</span>);
    }
}</pre><p>Notice the LastError property. This is a thread-safe way for the service to communicate its status with the user. This property is bound to a TextBlock on the UI.</p>
<p>The iTunes synchronization service makes changes directly to the data model. Because the data model is thread-safe, the UI thread and the background thread can share this resource. Update Controls will notify the UI thread whenever the background thread changes the data model.</p>
<p><strong>Try it out</strong><br /><a title="commuter.zip" href="http://adventuresinsoftware.com/blog/wp-content/uploads/2009/06/commuter.zip">Download the code</a>. When you run Commuter, it will launch iTunes. Even as iTunes launches, the Commuter user interface is responsive. If you are fast enough, you can open the Playlist drop-down before it is populated. But even if COM is faster than the mouse, you can try a few experiments.</p>
<p>Select a playlist in Commuter. Then switch to iTunes and rename that playlist. Within 10 seconds you'll see the selected playlist's name change.</p>
<p>Bring iTunes to the front, but leave Commuter visible underneath it. Place your mouse on the drop-down. Press Ctrl+N to create a new playlist, then click the mouse to bring Commuter to the front and open the drop-down. Within 10 seconds, "untitled playlist" will appear in the list.</p>
<p>Multi-threaded programming still requires some care, but Update Controls can at least take care of updating the UI when the background thread changes the data model.</p>
  </div>

  <ul class="links inline"><li class="comment_comments first last"><a href="../examples/multi-threading.html#comments" title="Jump to the first comment of this posting.">2 comments</a></li>
</ul>
</div></div> <!-- /node-inner, /node -->
<div id="node-3" class="node node-teaser node-type-blog"><div class="node-inner">

  
      <h2 class="title">
      <a href="../tips/viewmodel_navigationmodel.html" title="View Model and Navigation Model">View Model and Navigation Model</a>
    </h2>
  
  
      <div class="meta">
              <div class="submitted">
          Submitted by MichaelLPerry on Sat, 10/10/2009 - 12:24        </div>
      
          </div>
  
  <div class="content">
    <p>Update Controls automatically discovers dependencies upon your data model, and updates the UI when that data changes. It does not require that you register for or fire PropertyChanged events.</p>
<p><strong>Step 1: Write your data model</strong><br />Your data model is a set of plain-old CLR objects (POCOs). These objects have fields that store data, and properties that expose that data to consumers. They may also have validation logic, business logic, and other methods. The data model will be persisted, probably via a web service.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Customer
{
    <span style="color: blue">private</span> <span style="color: blue">string</span> _name;
    <span style="color: blue">private</span> List&lt;Invoice&gt; _invoices = <span style="color: blue">new</span> List&lt;Invoice&gt;();

    <span style="color: blue">public</span> <span style="color: blue">string</span> Name
    {
<span style="color: blue">        get</span> { <span style="color: blue">return</span> _name; }
        <span style="color: blue">set</span> { _name = value; }
    }

    <span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; Invoices
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _invoices; }
    }

    <span style="color: blue">public</span> Invoice NewInvoice(<span style="color: blue">string</span> number)
    {
        Invoice invoice = <span style="color: blue">new</span> Invoice(number);
        _invoices.Add(invoice);
        <span style="color: blue">return</span> invoice;
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Payment
{
    <span style="color: blue">private</span> Customer _customer;
    <span style="color: blue">private</span> List&lt;Invoice&gt; _paidInvoices = <span style="color: blue">new</span> List&lt;Invoice&gt;();

    <span style="color: blue">public</span> Payment(Customer customer)
    {
        _customer = customer;
    }

    <span style="color: blue">public</span> Customer Customer
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _customer; }
    }

    <span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; PaidInvoices
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _paidInvoices; }
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> AddPaidInvoice(Invoice invoice)
    {
        _paidInvoices.Add(invoice);
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> RemovePaidInvoice(Invoice invoice)
    {
        _paidInvoices.Remove(invoice);
    }
}</pre><p><br /><strong>Step 2: Add Independent sentries</strong><br />Add a reference to UpdateControls.Light.dll. Then create an Independent sentry for each field in your data model that can change. Call OnGet whenever you read the field, and OnSet whenever you change it.<br /></p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Customer
{
    <span style="color: blue">private</span> <span style="color: blue">string</span> _name;
    <span style="color: blue">private</span> List&lt;Invoice&gt; _invoices = <span style="color: blue">new</span> List&lt;Invoice&gt;();

<strong>    <span style="color: blue">private</span> Independent _indName = <span style="color: blue">new</span> Independent();
    <span style="color: blue">private</span> Independent _indInvoices = <span style="color: blue">new</span> Independent();
</strong>
    <span style="color: blue">public</span> <span style="color: blue">string</span> Name
    {
        <span style="color: blue">get</span> { <strong>_indName.OnGet();</strong> <span style="color: blue">return</span> _name; }
        <span style="color: blue">set</span> { <strong>_indName.OnSet();</strong> _name = value; }
    }

    <span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; Invoices
    {
        <span style="color: blue">get</span> { <strong>_indInvoices.OnGet();</strong> <span style="color: blue">return</span> _invoices; }
    }

    <span style="color: blue">public</span> Invoice NewInvoice(<span style="color: blue">string</span> number)
    {
        <strong>_indInvoices.OnSet();</strong>
        Invoice invoice = <span style="color: blue">new</span> Invoice(number);
        _invoices.Add(invoice);
        <span style="color: blue">return</span> invoice;
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Payment
{
    <span style="color: blue">private</span> Customer _customer;
    <span style="color: blue">private</span> List&lt;Invoice&gt; _paidInvoices = <span style="color: blue">new</span> List&lt;Invoice&gt;();

<strong>    <span style="color: blue">private</span> Independent _indPaidInvoices = <span style="color: blue">new</span> Independent();
</strong>
    <span style="color: blue">public</span> Payment(Customer customer)
    {
        _customer = customer;
    }

    <span style="color: blue">public</span> Customer Customer
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _customer; }
    }

    <span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; PaidInvoices
    {
        <span style="color: blue">get</span> { <strong>_indPaidInvoices.OnGet();</strong> <span style="color: blue">return</span> _paidInvoices; }
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> AddPaidInvoice(Invoice invoice)
    {
        <strong>_indPaidInvoices.OnSet();
</strong>        _paidInvoices.Add(invoice);
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> RemovePaidInvoice(Invoice invoice)
    {
        <strong>_indPaidInvoices.OnSet();
</strong>        _paidInvoices.Remove(invoice);
    }
}</pre><p><br /><strong>Step 3: Write your navigation model</strong><br />The navigation model keeps track of all of the user's selection. It helps the user navigate through the data model. Use Independent sentries, just like you did for the data model. But unlike the data model, the navigation model is not persistent.<br /></p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> PaymentNavigationModel
{
    <span style="color: blue">private</span> Invoice _selectedUnpaidInvoice;
    <span style="color: blue">private</span> Invoice _selectedPaidInvoice;

    <span style="color: blue">private</span> Independent _indSelectedUnpaidInvoice = <span style="color: blue">new</span> Independent();
    <span style="color: blue">private</span> Independent _indSelectedPaidInvoice = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> Invoice SelectedUnpaidInvoice
    {
        <span style="color: blue">get</span> { _indSelectedUnpaidInvoice.OnGet(); <span style="color: blue">return</span> _selectedUnpaidInvoice; }
        <span style="color: blue">set</span> { _indSelectedUnpaidInvoice.OnSet(); _selectedUnpaidInvoice = value; }
    }

    <span style="color: blue">public</span> Invoice SelectedPaidInvoice
    {
        <span style="color: blue">get</span> { _indSelectedPaidInvoice.OnGet(); <span style="color: blue">return</span> _selectedPaidInvoice; }
        <span style="color: blue">set</span> { _indSelectedPaidInvoice.OnSet(); _selectedPaidInvoice = value; }
    }
}</pre><p><br /><strong>Step 4: Write your view model</strong><br />The view model interprets the data model for the view. It has no data of its own. It just references the data model and the navigation model. It has a property for every bindable control in the view. It also has an ICommand property for every action the user can perform.<br /></p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> PaymentViewModel
{
    <span style="color: blue">private</span> Payment _payment;
    <span style="color: blue">private</span> PaymentNavigationModel _navigation;

    <span style="color: blue">public</span> PaymentViewModel(Payment payment, PaymentNavigationModel navigation)
    {
        _payment = payment;
        _navigation = navigation;
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> CustomerName
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _payment.Customer.Name; }
        <span style="color: blue">set</span> { _payment.Customer.Name = value; }
    }

    <span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; PaidInvoices
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _payment.PaidInvoices; }
    }

    <span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; UnpaidInvoices
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _payment.Customer.Invoices.Except(_payment.PaidInvoices); }
    }

    <span style="color: blue">public</span> Invoice SelectedPaidInvoice
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _navigation.SelectedPaidInvoice; }
        <span style="color: blue">set</span> { <span style="color: blue"></span>_navigation.SelectedPaidInvoice = <span style="color: blue">value</span>; }
    }

    <span style="color: blue">public</span> Invoice SelectedUnpaidInvoice
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _navigation.SelectedUnpaidInvoice; }
        <span style="color: blue">set</span> { <span style="color: blue"></span>_navigation.SelectedUnpaidInvoice = <span style="color: blue">value</span>; }
    }

    <span style="color: blue">public</span> ICommand AddPaidInvoices
    {
        <span style="color: blue">get</span>
        {
            <span style="color: blue">return</span> MakeCommand
                .When(() =&gt; _navigation.SelectedUnpaidInvoice != <span style="color: blue">null</span>)
                .Do(() =&gt;
                {
                    _payment.AddPaidInvoice(_navigation.SelectedUnpaidInvoice);
                    _navigation.SelectedPaidInvoice = _navigation.SelectedUnpaidInvoice;
                    _navigation.SelectedUnpaidInvoice = <span style="color: blue">null</span>;
                });
        }
    }

    <span style="color: blue">public</span> ICommand RemovePaidInvoices
    {
        <span style="color: blue">get</span>
        {
            <span style="color: blue">return</span> MakeCommand
                .When(() =&gt; _navigation.SelectedPaidInvoice != <span style="color: blue">null</span>)
                .Do(() =&gt;
                {
                    _payment.RemovePaidInvoice(_navigation.SelectedPaidInvoice);
                    _navigation.SelectedUnpaidInvoice = _navigation.SelectedPaidInvoice;
                    _navigation.SelectedPaidInvoice = <span style="color: blue">null</span>;
                });
        }
    }
}</pre><p><br /><strong>Step 5: Set the data context</strong><br />Now comes the magic. At no point did you fire or register for PropertyChanged events. You just wrote code that was concerned with the rules of your business (data model) and your user interface (view model and navigation model). Update Controls will fire those PropertyChanged events for you, if you wrap your view model before giving it to the view:<br /></p>
<pre>Customer customer = <span style="color: blue">new</span> Customer();
<span style="color: green">// Load the customer from the web service.</span>

Payment payment = <span style="color: blue">new</span> Payment(customer);
<span style="color: green">// Load the payment from the web service.</span>

DataContext = ForView.Wrap(
    <span style="color: blue">new</span> PaymentViewModel(
        payment,
        <span style="color: blue">new</span> PaymentNavigationModel()));</pre><p><br />Update Controls makes it much easier to create line-of-business applications in Silverlight 3, because you don't have to deal with INotifyPropertyChanged.</p>
  </div>

  <ul class="links inline"><li class="comment_add first last"><a href="../comment/reply/3.html#comment-form" title="Add a new comment to this page.">Add new comment</a></li>
</ul>
</div></div> <!-- /node-inner, /node -->
<div id="node-2" class="node node-teaser node-type-blog"><div class="node-inner">

  
      <h2 class="title">
      <a href="../mvvm-and-linq-to-sql.html" title="Linq to SQL">Linq to SQL</a>
    </h2>
  
  
      <div class="meta">
              <div class="submitted">
          Submitted by MichaelLPerry on Sat, 10/10/2009 - 12:01        </div>
      
          </div>
  
  <div class="content">
    <p>Download the <a href="../sites/default/files/noteworthy.zip">source code</a> and follow along.</p>
<p>The biggest challenge implementing the MVVM pattern is the View Model responding to changes in the Data Model. Usually, the View Model needs to subscribe to the PropertyChanged events fired by the Data Model, update its internal state, and then fire its own PropertyChanged events for the View. That's the hard way.</p>
<p>The easy way is to use <a href="../../index.html">Update Controls</a>. With Update Controls, you just decorate the Data Model and wrap the View Model. The library takes care of everything in between.</p>
<p><strong>Decorate a Linq to SQL data model</strong> <br />You decorate the data model by adding <a href="../../documentation/classDocumentation/vb/UpdateControls.Independent.html">Independent</a> sentries to every property. Whenever the property is accessed, call OnGet(). Whenever it is modified, call OnSet(). To decorate a Linq to SQL data model, we just need to inject these calls into the generated code. Unfortunately, the Linq to SQL code generator does not give you a way to easily tweak its output.</p>
<p>Damien Guard has solved that problem. His open source project <a href="http://l2st4.codeplex.com/">LINQ to SQL templates for T4</a> is incredibly easy to set up and start using. It drops straight into Visual Studio and replaces the build-in code generator with one that you control. With just a few edits to his provided T4 template, I replaced INotifyPropertyChanged with Independent sentries.</p>
<p>I added a sentry for each single-valued property, and called OnGet() inside of the getter and OnSet() in the setter. I also added a sentry for each collection. They require OnGet() in the getter, and OnSet() when something is added or removed. Finally, I added a sentry per table, to take care of the top-level queries. For these, I call OnSet() on any insert, update, and delete. The final T4 template is in the example source code.</p>
<p><strong>Wrap the view model for WPF</strong> <br />Wrapping the view model for the view is a one-liner.</p>
<pre><span style="color: blue">public</span> Window1()
{
    InitializeComponent();

    <span style="color: green">// Create a data model and a navigation model.</span>
    _blog = <span style="color: blue">new</span> Blog();
    BlogNavigationModel navigationModel = <span style="color: blue">new</span> BlogNavigationModel();

    <span style="color: green">// Put them both in a view model, then wrap it for the view.</span>
    <span style="color: blue">this</span>.DataContext = <strong>ForView.Wrap</strong>(<span style="color: blue">new</span> BlogViewModel(_blog, navigationModel));
}</pre><p>We create a view model based on the decorated data model and a similarly decorated navigation model (more on that later). Then we let Update Controls wrap it up before we give it to the view.</p>
<p><strong>View model per scope</strong> <br /><a href="../sites/default/files/images/UpdateControlsandLinqtoSQL_DBC6/Noteworthy.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="Noteworthy" align="right" src="../sites/default/files/images/UpdateControlsandLinqtoSQL_DBC6/Noteworthy_thumb.png" width="209" height="244" /></a>The example application -- Noteworthy -- is a blog editor. Different parts of the view focus on different granularities of data. The main view (shown in red) focuses on the blog as a whole. The article list items and detail pane (shown in blue) focus on a single article. And the tag list items (shown in green) focus on a single tag.</p>
<p>We define one view model class for each of these three scopes. Each one takes constructor parameters to put itself in context. So the BlogViewModel takes a Blog, the ArticleViewModel takes a Blog and an Article, and the TagViewModel takes a Blog and a Tag.</p>
<p>The DataContext property of a WPF control determines where it begins for data binding. If you don't set it, the control inherits it from its parent. If the control is an item in a list, then it is automatically set to an element of the ItemsSource. Finally, you can data bind to a property of its parent scope. Noteworthy uses all three techniques.</p>
<p><strong>Property per control attribute</strong> <br />WPF data binding connects control attributes to object properties. So within each view model, we define a property for each attribute of a control. The view model exists to serve of the view, so this one-to-one mapping is to be expected. The view model is an isolation layer designed to keep these view-specific concerns out of your data model.</p>
<p><strong>Navigation model per user context</strong> <br />The user of your application has a conceptual model of how controls should work together. Noteworthy is a single window program, so they expect all of the controls on that window to interact appropriately. If it had multiple child windows all within a parent, they would expect each window to be its own context, but participate within the context of the main window. And if it were a composite application, they would expect all of the components to work together.</p>
<p>Where the user draws their conceptual boundary, we create a navigation model. A navigation model records the user's point-of-view as they navigate through the application. It keeps track of their selection and temporary input.</p>
<p>All of the state in the navigation model is transient. Nothing is written to the database. Persistent state belongs in the data model. This keeps the view model completely stateless. The view model has only behavior, which depends upon the data model and the navigation model.</p>
<p>Because the navigation model is transient, we just write fields, select them, and hit Ctrl+D, G to generate the properties. For example, here's the property that records the selected article. The part that I wrote by hand is highlighted:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> BlogNavigationModel
{
<strong>    <span style="color: blue">private</span> Article _selectedArticle;
</strong>
    <span style="color: blue">#region</span> Independent properties
    <span style="color: green">// Generated by Update Controls --------------------------------</span>
    <span style="color: blue">private</span> Independent _indSelectedArticle = <span style="color: blue">new</span> Independent();

    <span style="color: gray">/// &lt;summary&gt;</span>
    <span style="color: gray">/// The article for which to display details.</span>
    <span style="color: gray">/// &lt;/summary&gt;</span>
    <span style="color: blue">public</span> Article SelectedArticle
    {
        <span style="color: blue">get</span> { _indSelectedArticle.OnGet(); <span style="color: blue">return</span> _selectedArticle; }
        <span style="color: blue">set</span> { _indSelectedArticle.OnSet(); _selectedArticle = value; }
    }
    <span style="color: green">// End generated code --------------------------------</span>
    <span style="color: blue">#endregion</span>
}</pre><p>The properties of the navigation model are always data model types, never view model types. The view model depends upon the navigation model, not vice-versa.</p>
<p><strong>Explore on your own</strong> <br />That's just enough to get you started. There are many interesting patterns that came together in the making of Noteworthy. Here are some that you might want to examine on your own:</p>
<ul>
<li>The BlogViewModel.Articles property is filtered by the selected tag.
</li><li>The article detail pane is a Grid within a Grid. The outer grid binds IsEnabled, while the inner grid binds DataContext.
</li><li>The TagListBoxStyle resource binds the ListBoxItem.IsSelected attribute to the TagViewModel.TagIsSelected property to support multiple selection.
</li><li>The Blog data model class uses a Dependent sentry to cache Tags.
</li><li>Every view model setter and command that affects the data model calls SubmitChanges.
</li><li>The ArticleViewModel.AvailableTags property uses .Except() to get all tags not assigned to the article.
</li><li>The BlogViewModel.SelectedArticle property wraps the data object from the navigation model in a view model, and then unwraps it on the way back.
</li><li>The first tag in BlogViewModel.Filters is actually not a tag at all. It is a null to represent the lack of a filter. </li>
</ul>
<p>Expect future posts to return to this example and explore these points in more detail.</p>
  </div>

  <ul class="links inline"><li class="comment_comments first last"><a href="../mvvm-and-linq-to-sql.html#comments" title="Jump to the first comment of this posting.">2 comments</a></li>
</ul>
</div></div> <!-- /node-inner, /node -->
<div class="item-list"><ul class="pager"><li class="pager-first first"><a href="1.html" title="Go to first page" class="active">« first</a></li>
<li class="pager-previous"><a href="19ba9.html?page=3" title="Go to previous page" class="active">‹ previous</a></li>
<li class="pager-item"><a href="1.html" title="Go to page 1" class="active">1</a></li>
<li class="pager-item"><a href="12679.html?page=1" title="Go to page 2" class="active">2</a></li>
<li class="pager-item"><a href="14658.html?page=2" title="Go to page 3" class="active">3</a></li>
<li class="pager-item"><a href="19ba9.html?page=3" title="Go to page 4" class="active">4</a></li>
<li class="pager-current last">5</li>
</ul></div>        </div>

                  <div class="feed-icons"><a href="1/feed" class="feed-icon"><img src="../misc/feed.png" alt="Syndicate content" title="RSS - MichaelLPerry&#039;s blog" width="16" height="16" /></a></div>
        
        
      </div></div> <!-- /#content-inner, /#content -->

              <div id="navbar"><div id="navbar-inner" class="clear-block region region-navbar">

          <a name="navigation" id="navigation"></a>

          
                      <div id="primary">
              <ul class="links"><li class="menu-146 first"><a href="../../cs/index-2.html" title="">WPF</a></li>
<li class="menu-147"><a href="../../cs/silverlight.html" title="">Silverlight</a></li>
<li class="menu-148"><a href="../../cs/winforms.html" title="">Winforms</a></li>
<li class="menu-149"><a href="../../cs/download.html" title="">Download</a></li>
<li class="menu-150"><a href="../index.html" title="">Documentation</a></li>
<li class="menu-151"><a href="../../cs/videos.html" title="">Videos</a></li>
<li class="menu-152 last"><a href="../../cs/contact.html" title="">Contact Us</a></li>
</ul>            </div> <!-- /#primary -->
          
          
          
        </div></div> <!-- /#navbar-inner, /#navbar -->
      
              <div id="sidebar-left"><div id="sidebar-left-inner" class="region region-left">
          <div id="block-book-0" class="block block-book region-odd odd region-count-1 count-1"><div class="block-inner">

      <h2 class="title">Sections</h2>
  
  <div class="content">
    <div id="book-block-menu-43" class="book-block-menu">
  <ul class="menu"><li class="collapsed first last"><a href="../basics.html">The Basics</a></li>
</ul></div>
<div id="book-block-menu-11" class="book-block-menu">
  <ul class="menu"><li class="collapsed first last"><a href="../examples.html">Examples</a></li>
</ul></div>
<div id="book-block-menu-12" class="book-block-menu">
  <ul class="menu"><li class="collapsed first last"><a href="../tips.html">Tips</a></li>
</ul></div>
<div id="book-block-menu-32" class="book-block-menu">
  <ul class="menu"><li class="collapsed first last"><a href="../advanced.html">Advanced Topics</a></li>
</ul></div>
<div id="book-block-menu-24" class="book-block-menu">
  <ul class="menu"><li class="collapsed first last"><a href="../node/24.html">Other Articles</a></li>
</ul></div>
  </div>

  
</div></div> <!-- /block-inner, /block -->
<div id="block-node-0" class="block block-node region-even even region-count-2 count-2"><div class="block-inner">

      <h2 class="title">Subscribe</h2>
  
  <div class="content">
    <a href="../rss.xml" class="feed-icon"><img src="../misc/feed.png" alt="Syndicate content" title="Syndicate" width="16" height="16" /></a>  </div>

  
</div></div> <!-- /block-inner, /block -->
<div id="block-comment-0" class="block block-comment region-odd odd region-count-3 count-3"><div class="block-inner">

      <h2 class="title">Recent comments</h2>
  
  <div class="content">
    <div class="item-list"><ul><li class="first"><a href="../mvvm-and-linq-to-sql.html#comment-687">No longer preferred</a><br />3 years 13 weeks ago</li>
<li><a href="../mvvm-and-linq-to-sql.html#comment-684">Is this still the preferred way?</a><br />3 years 19 weeks ago</li>
<li><a href="../tips/common_mistakes_observablecollection.html#comment-668" class="active">Wrong. When replacing the</a><br />3 years 44 weeks ago</li>
<li><a href="../node/39.html#comment-667">Very nice</a><br />3 years 46 weeks ago</li>
<li><a href="../node/39.html#comment-666">Example Application</a><br />3 years 47 weeks ago</li>
<li><a href="../basics/make-command.html#comment-665">Responsibilities</a><br />4 years 3 days ago</li>
<li><a href="../basics/make-command.html#comment-664">Menus</a><br />4 years 3 days ago</li>
<li><a href="../tips/common_mistakes_observablecollection.html#comment-659" class="active">The reason that this is a</a><br />4 years 17 weeks ago</li>
<li><a href="../tips/common_mistakes_observablecollection.html#comment-658" class="active">You need to explain why these</a><br />4 years 17 weeks ago</li>
<li class="last"><a href="../validation.html#comment-657">RE: I like your approach, but ...</a><br />4 years 21 weeks ago</li>
</ul></div>  </div>

  
</div></div> <!-- /block-inner, /block -->
<div id="block-user-0" class="block block-user region-even even region-count-4 count-4"><div class="block-inner">

      <h2 class="title">User login</h2>
  
  <div class="content">
    <form action="http://updatecontrols.net/doc/blog/1?destination=blog%2F1%3Fpage%3D4"  accept-charset="UTF-8" method="post" id="user-login-form">
<div><div class="form-item" id="edit-name-wrapper">
 <label for="edit-name">Username: <span class="form-required" title="This field is required.">*</span></label>
 <input type="text" maxlength="60" name="name" id="edit-name" size="15" value="" class="form-text required" />
</div>
<div class="form-item" id="edit-pass-wrapper">
 <label for="edit-pass">Password: <span class="form-required" title="This field is required.">*</span></label>
 <input type="password" name="pass" id="edit-pass"  maxlength="60"  size="15"  class="form-text required" />
</div>
<input type="submit" name="op" id="edit-submit" value="Log in"  class="form-submit" />
<div class="item-list"><ul><li class="first last"><a href="../user/password.html" title="Request new password via e-mail.">Request new password</a></li>
</ul></div><input type="hidden" name="form_build_id" id="form-7a631e95eb94410cfbf5943bda2ec123" value="form-7a631e95eb94410cfbf5943bda2ec123"  />
<input type="hidden" name="form_id" id="edit-user-login-block" value="user_login_block"  />

</div></form>
  </div>

  
</div></div> <!-- /block-inner, /block -->
        </div></div> <!-- /#sidebar-left-inner, /#sidebar-left -->
      
      
    </div></div> <!-- /#main-inner, /#main -->

          <div id="footer"><div id="footer-inner" class="region region-footer">

        
        <div id="block-system-0" class="block block-system region-odd odd region-count-1 count-5"><div class="block-inner">

  
  <div class="content">
    <a href="http://drupal.org/"><img src="../misc/powered-blue-80x15.png" alt="Powered by Drupal, an open source content management system" title="Powered by Drupal, an open source content management system" width="80" height="15" /></a>  </div>

  
</div></div> <!-- /block-inner, /block -->

      </div></div> <!-- /#footer-inner, /#footer -->
    
  </div></div> <!-- /#page-inner, /#page -->

  
  <script type="text/javascript" src="../sites/all/modules/google_analytics/googleanalytics4b43.js?r"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
//--><!]]>
</script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
try{var pageTracker = _gat._getTracker("UA-389401-4");pageTracker._trackPageview();} catch(err) {}
//--><!]]>
</script>

</body>

<!-- Mirrored from updatecontrols.net/doc/blog/1?page=4 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:54:22 GMT -->
</html>
